# 1. cargo-bloat 
A cargo tool used for Aanalyzing Rust binary sizes.

This tool is useful for addressing

- Increased Compilation Times
- Larger Binary Sizes
- Longer Deployment Times
- Higher Resource Consumption

## Installation 
```shell
cargo install cargo-bloat
```

## How to use cargo bloat
Use the following command to analyze the factors contributing to the overall size of various functions in Ripple 2.0.
```shell
cargo bloat --release --all-features --full-fn -n 10000 --message-format json
```
A sample report is available as  [cargo-bloat-result.json](supported_files_and_images/cargo-bloat-result.json) , [cargo-bloat-ripple_comcast_extns.json](supported_files_and_images/cargo-bloat-ripple_comcast_extns.json) files. Refer [RPPL-1840](https://ccp.sys.comcast.net/browse/RPPL-1840) more detailed reports in text/html formats. 

Notably, the clone(), serde Serialize(), and Deserialize() functions emerge as the primary contributors to binary size.  

The list of the biggest dependencies in the release build can be identified by using the following command
```shell
cargo bloat --release --all-features --crates
```

Sample result: 
```shell
 File  .text     Size Crate
22.2%  56.6%   2.4MiB ripple_sdk
 6.9%  17.6% 762.4KiB std
 2.3%   5.8% 250.5KiB tokio
 1.7%   4.4% 190.2KiB regex_syntax
 ```

where 

_File_   :  Relative contributor of different source files or creates to the binary  
_.text_  :  The percentage of the .text segment (executable instructions) of the binary that each entry contributes. 

## Best Practices 
- Regularly monitor binary sizes
- Automate Cargo bloat analysis in CI/CD pipelines
- Document dependencies and their impacts.
- Optimize dependencies for production build


# 2. cargo-unused-features
This cargo tool allows to find and prune enabled, but unused feature flags from project.
## Installation 
```shell
cargo install cargo-unused-features
 ```
## Analyse 
Use the following command to analyze unused features from the various crates used in Ripple project
```shell
$ cd eos-ripple
$ unused-features analyze
```
The report is captured in [unused_features.txt](supported_files_and_images/unused_features.txt) file

A report.json file will be generated on the project directory of each crates. 

An HTML report can be generated by running the following command.
```shell
$ cd eos-ripple
$ unused-features build-report --input <crate_path/report.json>
```
Refer [this](supported_files_and_images/thunder_report.html) sample HTML report for more details.

## Prune unused features from Cargo.toml
Here is the instruction to prune unused features. 
```shell
$ cd eos-ripple
$ unused-features prune --input <crate_path/report.json>
```

Care must be taken before applying this changes to Cargo.toml file as there may be hidden dependency with the pruned features.  
A sample pruned version of Ripple/core/sdk/Cargo.toml file is available [here](supported_files_and_images/Cargo.toml) for reference.


# References
- [Reducing the size of a Rust GStreamer plugin](https://www.collabora.com/news-and-blog/blog/2020/04/28/reducing-size-rust-gstreamer-plugin/)
- [Min Sized Rust](https://github.com/johnthagen/min-sized-rust)