groups:
- name: pr
  jobs:
  - pr-dpab-core
  - calculate-dpab-core-main-coverage-job

jobs:
- name: pr-dpab-core
  plan:
  - get: code-coverage-branch
  - get: dpab-core
    resource: dpab-core-pull-request
    trigger: true
  - params:
      path: dpab-core
      status: pending
    put: dpab-core-pull-request
  - file: dpab-core/ci/scripts/pr-dpab-core.yaml
    task: check-pr
    input_mapping:
      code-coverage: code-coverage-branch
      codebase: dpab-core
    on_failure:
      do:
      - put: dpab-core-pull-request
        params:
          comment_file: comment/comment
          delete_previous_comments: true
          path: dpab-core
          status: failure
    on_success:
      do:
      - put: dpab-core-pull-request 
        params:
          comment_file: comment/comment
          delete_previous_comments: true
          path: dpab-core
          description: Sanity checks passed.
          status: success
        
    params:
      RELEASE_VERSION: pr
      GIT_USER_EMAIL: ((svc-email))
      GIT_USER_NAME: ((svc-name))
      REPO_PRIVATE_KEY: ((github-enterprise.private-key))

- name: calculate-dpab-core-main-coverage-job
  plan:
  - get: dpab-core-main-branch
    trigger: true
  - get: code-coverage-branch
  - task: calculate-dpab-core-main-coverage-task
    input_mapping:
      code-coverage: code-coverage-branch
      codebase: dpab-core-main-branch
    config:
      platform: linux
      image_resource:
        type: docker-image
        source:
          repository: 879945319661.dkr.ecr.us-east-1.amazonaws.com/ripple/build-tools
          tag: rust-1.58.1
          aws_access_key_id: ((eks_aws_access_key))
          aws_secret_access_key: ((eks_aws_secret_key))
      inputs:
        - name: codebase
        - name: code-coverage
      outputs:
        - name: code-coverage-branch
      run:
        path: sh
        args:
        - -exc
        - |
          set -x
          export UNIT_TEST_COVERAGE_FILE="/coverage.txt"
          codebase/ci/scripts/get-coverage-from-main.sh
          cp -a code-coverage/. code-coverage-branch/
    params:
      GIT_USER_EMAIL: ((svc-email))
      GIT_USER_NAME: ((svc-name))
      REPO_PRIVATE_KEY: ((github-enterprise.private-key))

  - put: code-coverage-branch
    params:
      repository: code-coverage-branch
      branch: code-coverage

resource_types:

- name: pull-request
  source:
    repository: teliaoss/github-pr-resource
  type: docker-image

- name: s3-resource-simple
  type: docker-image
  source:
    repository: 18fgsa/s3-resource-simple

resources:

- check_every: 24h
  name: dpab-core-pull-request
  source:
    access_token: ((github-enterprise.access-token))
    repository: ottx/dpab_core
    v3_endpoint: https://github.comcast.com/api/v3/
    v4_endpoint: https://github.comcast.com/api/graphql
  type: pull-request
  webhook_token: ((github-enterprise.webhook-token))

- name: code-coverage-branch
  type: git
  webhook_token: ((github-enterprise.webhook-token))
  source:
    uri: git@github.comcast.com:ottx/dpab_core.git
    private_key: ((github-enterprise.private-key))
    branch: code-coverage

- name: dpab-core-main-branch
  type: git
  check_every: 5m
  webhook_token: ((github-enterprise.webhook-token))
  source:
    uri: git@github.comcast.com:ottx/dpab_core.git
    private_key: ((github-enterprise.private-key))
    branch: main
